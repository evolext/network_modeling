<!DOCTYPE html>

<head>
   <title>Название страницы</title>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <style>
      #map
      {
         margin: 0;
         padding: 10px;
         background-color: rgba(184, 181, 181, 0.993);
         float: left;
         width: 1000px;
      }
      /* Стилизация баллунов объектов */
      .contextButton
      {
         text-align: left;
         padding-left: 25px;
         padding-top: 4px;
         padding-bottom: 4px;
         width: 100%;
         border: none;
         cursor: pointer;
         background-color: white;
         background-repeat: no-repeat;
      }
      #buttonAddPipeBySource
      {
         background-size: 23px;
         background-image: url('icons/pipe.png');
      }
      #buttonAddPipeByHeatchamber
      {
         background-size: 23px;
         background-image: url('icons/pipe.png');
      }
      #deleteSource, #deleteHeatchamber, #deleteReciever
      {
         background-size: 23px;
         background-image: url('icons/cross.png');
      }
      /* Стилизация панели инструментов */
      #toolsPanel
      {
         background-color: rgba(184, 181, 181, 0.993);
         height: 620px;
      }
      #toolsPanel input
      {
         font-family: Verdana, Geneva, Tahoma, sans-serif;
         margin-top: 10px;
         width: 200px;
         height: 30px;
         padding: 0;
         font: inherit;
         color: inherit;
         background-color: transparent;

         background-size: 28px;
         background-repeat: no-repeat;
         background-color: rgb(231, 226, 226);
         margin-right: 200px;
         border: 1px solid black;
         display: inline-block;
         cursor: pointer;
      }
      #sourceTool
      {
         background-image: url('icons/factory.png');
      }
      #heatchamberTool
      {
         background-image: url('icons/rectangle.png');
      }
      #recieverTool
      {
         background-image: url('icons/circle.png');
      }
   </style>
   <script src="https://api-maps.yandex.ru/2.1/?apikey=<4f266832-6999-4dd9-8e72-85b8fc143c69>&lang=ru_RU"
      type="text/javascript">
      </script>
   <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
   <script type="text/javascript">
      ymaps.ready(init);
      var myMap;
      // Массив, содержащий все добавленные на карту источники
      var sources_array = [];
      // Массив, содержащий все добавленные на карту тепловые камеры
      var heatchambers_array = [];
      // Массив, содержащий все добавленные на карту пути
      var pipes_array = [];
      // Массив, содержащий все добавленные на карту конечные узлы
      var recievers_array = [];
      // Массив, содержащий все добавленные на карту ответвления
      var branches_array = [];

      // Функция построения карты
      function init() {
         myMap = new ymaps.Map("map", {
               center: [54.9926, 82.9136],  // изначальный центр карты
               zoom: 15,                    // параметр масштабирования
               //элементы управления
               controls: [],
         });
         // Подключаем кнопку "показать на весь экран"
         var fullscreenControl = new ymaps.control.FullscreenControl({ options: { float: "right" } });
         myMap.controls.add(fullscreenControl); // присоединяем к карте
         // Кнопка "тип карты"
         var typeSelector = new ymaps.control.TypeSelector({ options: { float: "left", floatIndex: 200 } });
         myMap.controls.add(typeSelector); // присоединяем к карте
         // Ползунок масштабирования
         var zoomControl = new ymaps.control.ZoomControl(
            {
               options:
               {
                  position:
                  {
                     right: 10,
                     top: 50
                  },
                  size: "large"
               }
            });
         // Присоединяем к карте полузок масштабирования
         myMap.controls.add(zoomControl);
      }

      // Инициализация источника
      function source_init() 
      {
         var tmp = new ymaps.Placemark(myMap.getCenter(), 
         {
            // Баллун, он же контекстное меню
            balloonContent: 
               '<button class="add_pipe_by_source contextButton" id="buttonAddPipeBySource" data-source_id="' + sources_array.length + '">Начать путь</button>' +
               '<br>' +
               '<button class="delete_source contextButton" id="deleteSource" data-source_id="' + sources_array.length + '">Удалить источник</button>'
         },
         {
            // Попытаемся задать свой макет
            iconLayout: 'default#image',
            // Своё изображение иконки метки.
            iconImageHref: 'icons/factory.png',
            // Размеры метки.
            iconImageSize: [40, 40],
            // Смещение левого верхнего угла иконки относительно
            // её "ножки" (точки привязки).
            iconImageOffset: [-20, -34],


            // Фигуру возможно передвигать
            draggable: true,
            zIndex: 200
         });

         // Событие: открыть баллун после окончания перетаскивания (как в giszulu)
         tmp.events.add('dragend', function (e) {
            e.originalEvent.target.balloon.open();
         });

         // Добавление информации в массив источников
         sources_array.push(tmp);
         // Добавление объекта на карту
         myMap.geoObjects.add(tmp);
      }

      // Инициализация тепловой камеры
      function heatchamber_init()
      {
         var left_point = myMap.getCenter();
         var right_point = myMap.getCenter();

         // Примерные размеры
         left_point[0] -= 0.000025;
         left_point[1] -= 0.00005;

         right_point[0] += 0.000025;
         right_point[1] += 0.00005;

         var heat_chamber = new ymaps.Rectangle([
            [left_point[0], left_point[1]],
            [right_point[0], right_point[1]]
         ],
         {
            // Баллун, он же контекстное меню
            balloonContent: 
                  '<button class="add_pipe_by_heatchamber contextButton" id="buttonAddPipeByHeatchamber" data-heatchamber_id="' + heatchambers_array.length +  '">Начать путь</button>' +
                  '<br>' +
                  '<button class="delete_heatchamber contextButton" id="deleteHeatchamber" data-heatchamber_id="' + heatchambers_array.length + '">Удалить тепловую камеру</button>'
         },
         {
            zIndex: 200,
            // Возможность передвигать фигуру
            draggable: true,
            // Цвет фона и контура
            fillColor: '#fcb103',
            strokeColor: '#fc6203'
         });

         // Событие: открыть баллун после окончания перетаскивания (как в giszulu)
         heat_chamber.events.add('dragend', function (e) {
            e.originalEvent.target.balloon.open();
         });

         // Добавляем информацию в массив
         heatchambers_array.push(heat_chamber);
         // Добавление на карту
         myMap.geoObjects.add(heat_chamber);
      }

      // Инициализация конечного узла тепловой системы
      function reciever_init()
      {
         var center_point = myMap.getCenter();

         var reciever = new ymaps.Circle([
            // Центр окружности
            center_point,
            // Радиус в метрах
            2
         ],
         {
            balloonContent:
               '<button class="delete_reciever contextButton" id="deleteReciever" data-reciever_id="' + recievers_array.length + '">Удалить конечный узел</button>'
         },
         {
            // Можно передвигать фигуру
            draggable: true,
            fillColor: '#6632a8',
            strokeColor: '#5032a8',
            strokeWidth: 2,

            zIndex: 200
         });

         // Событие: открыть баллун после окончания перетаскивания (как в giszulu)
         reciever.events.add('dragend', function (e) {
            e.originalEvent.target.balloon.open();
         });

         // Добавляем информацию в массив
         recievers_array.push(reciever);
         // Добавление на карту
         myMap.geoObjects.add(reciever);
      }
      
      // Инициализация трубы, на вход подаются координаты точки
      function pipe_init(coordinates)
      {
         var pipe = new ymaps.Polyline([
            coordinates
         ],
         {
         },
         {
            zIndex: 100,
            // Толщина линии
            strokeWidth: 2,
            // Добавляем собственные функции
            editorMenuManager: function (items, event) {
               // Удаление всего пути
               items.push({
                  title: "Удалить весь путь",
                  onClick: function () {
                     myMap.geoObjects.remove(pipe);
                  }
               });
               items.push({
                  title: "Закончить путь",
                  onClick: function () {
                     pipe.editor.stopEditing();
                  }
               });
               items.push({
                  title: "Ответвление",
                  onClick: function () {
                     branch_init(event.geometry._coordinates);
                     pipe_init(event.geometry._coordinates);
                     event._parent.editor.stopEditing();
                  }
               });
               items.push({
                  title: "Установить тепловую камеру",
                  onClick: function () {
                     // Меняем центр карты
                     myMap.setCenter(event.geometry._coordinates);
                     // Инициализация тепловой камеры
                     heatchamber_init();
                     pipe_init(event.geometry._coordinates);
                     event._parent.editor.stopEditing();
                  }
               });
               items.push({
                  title: "Установить конечный узел",
                  onClick: function () {
                     // Меняем центр карты
                     myMap.setCenter(event.geometry._coordinates);
                     // Инициализация тепловой камеры
                     reciever_init();
                     event._parent.editor.stopEditing();
                  }
               });
               return items;
            }
         }
         );

         // Добавляем в глобальный массив объектов
         pipes_array.push(pipe);
         // Добавление на карту
         myMap.geoObjects.add(pipe);
         // Старт режима редактирования линии
         pipe.editor.startDrawing();
      }

      // Функция создания ответвления
      function branch_init(coordinates)
      {
         // Геометрически ответвление представляет собой черный круг
         var branch = new ymaps.Circle([
            // Центр окружности
            coordinates,
            // Радиус в метрах
            1.5
         ],
         {
         },
         {
            fillColor: '#3d3c3a',
            strokeColor: '#292825',
            strokeWidth: 2,
            zIndex: 200
         });

         // Добавляем информацию в массив
         branches_array.push(branch);
         // Добавление на карту
         myMap.geoObjects.add(branch);
      }
   </script>
</head>

<body>
   <!--Контейнер для карты-->
   <div id="map" style="width: 1000px; height: 600px;"></div>
   <div id="toolsPanel">
      <input type="button" value="Источник" id="sourceTool" onclick="source_init()">
      <input type="button" value="Тепловая камера" id="heatchamberTool" onclick="heatchamber_init()">
      <input type="button" value="Конечный узел" id="recieverTool" onclick="reciever_init()">
   </div>
</body>

<script>
   // Функция удаления источника с карты
   $('body').on('click', '.delete_source', function (e) 
   {
      // Удаление с карты
      myMap.geoObjects.remove(sources_array[$(this).data('source_id')]);
      // Удаление из глобального массива объектов
      sources_array.splice($(this).data('source_id'), 1);
   });

   // Удаление тепловой камеры с карты
   $('body').on('click', '.delete_heatchamber', function (e) {
      myMap.geoObjects.remove(heatchambers_array[$(this).data('heatchamber_id')]);
   });

   // Функция удаления конечного узла сети с карты
   $('body').on('click', '.delete_reciever', function (e) {
      myMap.geoObjects.remove(recievers_array[$(this).data('reciever_id')]);
   });

   // Инициализация трубы от источника
   $('body').on('click', '.add_pipe_by_source', function (e) 
   {
      var pipe = new ymaps.Polyline([
         sources_array[$(this).data('source_id')].geometry._coordinates
      ],
      {
         draggable: true
      },
      {
         zIndex: 100,
         // Толщина линии
         strokeWidth: 2,
         // Добавляем собственные функции
         editorMenuManager: function(items, event)
         {
            // Удаление всего пути
            items.push({
               title: "Удалить весь путь",
               onClick: function() {
                  myMap.geoObjects.remove(pipe);
               }
            });
            items.push({
               title: "Закончить путь",
               onClick: function () {
                  pipe.editor.stopEditing();
               }
            });
            items.push({
               title: "Ответвление",
               onClick: function () {
                  branch_init(event.geometry._coordinates);
                  pipe_init(event.geometry._coordinates);
                  event._parent.editor.stopEditing();
               }
            });
            items.push({
               title: "Установить тепловую камеру",
               onClick: function () {
                  // Меняем центр карты
                  myMap.setCenter(event.geometry._coordinates);
                  // Инициализация тепловой камеры
                  heatchamber_init();
                  event._parent.editor.stopEditing();
               }
            });
            items.push({
               title: "Установить конечный узел",
               onClick: function () {
                  // Меняем центр карты
                  myMap.setCenter(event.geometry._coordinates);
                  // Инициализация тепловой камеры
                  reciever_init();
                  event._parent.editor.stopEditing();
               }
            });
            return items;
         }
      }
      );

      // Автоматическое закрытие балуна после нажатия кнопки
      sources_array[$(this).data('source_id')].balloon.close();
      sources_array[$(this).data('source_id')].options._options.draggable = false;

      pipes_array.push(pipe);

      myMap.geoObjects.add(pipe);
      pipe.editor.startDrawing();
   });

   // Инициализация трубы от тепловой камеры
   $('body').on('click', '.add_pipe_by_heatchamber', function (e) {
      // Вычисляем центр объекта "прямоугольник"
      var object = heatchambers_array[$(this).data('heatchamber_id')];

      var x_center = object.geometry._bounds[0][1] + (object.geometry._bounds[1][1] - object.geometry._bounds[0][1])/2;
      var y_center = object.geometry._bounds[0][0] + (object.geometry._bounds[1][0] - object.geometry._bounds[0][0])/2;

      var pipe = new ymaps.Polyline([
         [y_center, x_center]
      ],
      {
      },
      {
         zIndex: 100,
         // Толщина линии
         strokeWidth: 2,
         // Добавляем собственные функции
         editorMenuManager: function (items, event) {
            // Удаление всего пути
            items.push({
               title: "Удалить весь путь",
               onClick: function () {
                  myMap.geoObjects.remove(pipe);
               }
            });
            items.push({
               title: "Закончить путь",
               onClick: function () {
                  pipe.editor.stopEditing();
               }
            });
            items.push({
               title: "Ответвление",
               onClick: function () {
                  branch_init(event.geometry._coordinates);
                  pipe_init(event.geometry._coordinates);
                  event._parent.editor.stopEditing();
               }
            });
            items.push({
               title: "Установить тепловую камеру",
               onClick: function () {
                  // Меняем центр карты
                  myMap.setCenter(event.geometry._coordinates);
                  // Инициализация тепловой камеры
                  heatchamber_init();
                  pipe_init(event.geometry._coordinates);
                  event._parent.editor.stopEditing();
               }
            });
            items.push({
               title: "Установить конечный узел",
               onClick: function () {
                  // Меняем центр карты
                  myMap.setCenter(event.geometry._coordinates);
                  // Инициализация тепловой камеры
                  reciever_init();
                  event._parent.editor.stopEditing();
               }
            });
            return items;
         }
      }
      );

      // Автоматическое закрытие балуна после нажатия кнопки
      heatchambers_array[$(this).data('heatchamber_id')].balloon.close();
      // Запрет на передвижение тепловой камеры
      //heatchambers_array[$(this).data('heatchamber_id')].options._options.draggable = false;

      pipes_array.push(pipe);

      myMap.geoObjects.add(pipe);
      pipe.editor.startDrawing();
   });

</script>

</html>