<!DOCTYPE html>
<head>
   <title>Название страницы</title>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <link rel="stylesheet" type="text/css" href="style.css">
   <!-- Подключение API яндекс карт -->
   <script src="https://api-maps.yandex.ru/2.1/?apikey=<4f266832-6999-4dd9-8e72-85b8fc143c69>&lang=ru_RU" type="text/javascript"></script>
   <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
   <script type="text/javascript">
      ymaps.ready(init);
      // Переменная, являющася контейнером для карты
      var myMap;
      // Массив, содержащий все добавленные на карту источники
      var sources_array = new Map();
      // Массив, содержащий все добавленные на карту тепловые камеры
      var heatchambers_array = new Map();
      // Массив, содержащий все добавленные на карту пути
      var pipes_array = new Map();
      // Массив, содержащий все добавленные на карту конечные узлы
      var recievers_array = new Map();
      // Массив, содержащий все добавленные на карту ответвления
      var branches_array = new Map();
      // Глобальная переменная для идентификации каждого элемента сети
      var id = 0;
      // Массив, содержащий всю информацию о геообъектах
      var objects_data = new Map();

      // Переменная, отвечающая за текущий режим
      // 1-й: показывать\скрывать названия геообъектов
      var MODES = {
         showObjectNames: false // По умолчанию названия геообъектов не отображаются
      };


      // Функция построения карты
      function init() {
         myMap = new ymaps.Map("map", {
               center: [54.9926, 82.9136],  // изначальный центр карты
               zoom: 15,                    // параметр масштабирования
               //элементы управления
               controls: [],
         });
         // Подключаем кнопку "показать на весь экран"
         var fullscreenControl = new ymaps.control.FullscreenControl({ options: { float: "right" } });
         myMap.controls.add(fullscreenControl); // присоединяем к карте
         // Кнопка "тип карты"
         var typeSelector = new ymaps.control.TypeSelector({ options: { float: "left", floatIndex: 200 } });
         myMap.controls.add(typeSelector); // присоединяем к карте
         // Ползунок масштабирования
         var zoomControl = new ymaps.control.ZoomControl(
            {
               options:
               {
                  position:
                  {
                     right: 10,
                     top: 50
                  },
                  size: "large"
               }
            });
         // Присоединяем к карте полузок масштабирования
         myMap.controls.add(zoomControl);
      }

      // Инициализация источника
      function source_init() 
      {
         let iconContent = '';
         // Если режим отображения имен геообъектов включен, то меняем содержимое на название
         if (MODES.showObjectNames)
            iconContent = '<span class="object_names">Источник №1</span>';

         var tmp = new ymaps.Placemark(myMap.getCenter(), 
         {
            // Баллун, он же контекстное меню
            balloonContent:   '<button class="add_pipe_by_source contextButton" id="buttonAddPipeBySource" data-source_id="' + id + '">Начать путь</button>' + 
                              '<br>' +
                              '<button class="show_source_info contextButton info" data-source_id="' + id + '">Информация</button>' +
                              '<br>' +
                              '<button class="delete_source contextButton" id="deleteSource" data-source_id="' + id + '">Удалить источник</button>',
            // Подпись к геообъекту с его названием (изначально название не отображается)
            iconContent: iconContent
         },
         {
            // Свой макет изображения объекта, 
            // также возможно добавить подпись к объекту
            iconLayout: 'default#imageWithContent',
            // Своё изображение иконки метки.
            iconImageHref: '/icons/factory.png',

            // Размеры метки
            iconImageSize: [40, 40],
            // Смещение левого верхнего угла иконки относительно
            // её "ножки" (точки привязки)
            iconImageOffset: [-20, -34],

            // Смещениие надписи с названием геообъеекта
            iconContentOffset: [5, -25],
            // Размер надписи с названием геообъеекта
            iconContentSize: [100, 10],

            // Смещение балуна относительно первоначальной точки привязки
            balloonOffset: [6, -30],
            // Не скрывать сам объект при открытии балуна
            hideIconOnBalloonOpen: false,

            // Фигуру возможно передвигать
            draggable: true,
            zIndex: 200
         });

         // Событие: открыть баллун после окончания перетаскивания (как в giszulu)
         tmp.events.add('dragend', function (e) {
            e.originalEvent.target.balloon.open();
         });

         // Сохраняем подпись с названием объекта,
         // понадобится при нажатии на кнопку отобажения подписей объектов
         tmp.name = '<span class="object_names">Источник №1</span>';

         // Структура данных для хранения информации об источнике
         var data = [];
         data.push({ value: "0"});
         data.push({ value: "0" });
         data.push({ value: "0" });
         // Добавление информации в глобальный массив
         objects_data.set(id, data);

         // Добавление информации в массив источников
         sources_array.set(id++, tmp);
         // Добавление объекта на карту
         myMap.geoObjects.add(tmp);
      }

      // Инициализация тепловой камеры
      function heatchamber_init(coordinates)
      {
         var heat_chamber = new ymaps.Placemark(coordinates,
         {
            // Баллун, он же контекстное меню
            balloonContent: 
                  '<button class="add_pipe_by_heatchamber contextButton" id="buttonAddPipeByHeatchamber" data-heatchamber_id="' + id +  '">Начать путь</button>' +
                  '<br>' +
                  '<button class="show_heatchamber_info contextButton info" data-heatchamber_id="' + id + '">Информация</button>' +
                  '<br>' +
                  '<button class="delete_heatchamber contextButton" id="deleteHeatchamber" data-heatchamber_id="' + id + '">Удалить тепловую камеру</button>'
         },
         {
            zIndex: 200,
            // Возможность передвигать фигуру
            draggable: true,
            // Настройка собственного изображения
            iconLayout: 'default#image',
            // Своё изображение иконки метки.
            iconImageHref: '/icons/rectangle.png',
            // Размеры метки.
            iconImageSize: [25, 25],
            // Смещение левого верхнего угла иконки относительно
            // её "ножки" (точки привязки).
            iconImageOffset: [-13,-12]
         });

         // Событие: открыть баллун после окончания перетаскивания (как в giszulu)
         heat_chamber.events.add('dragend', function (e) {
            e.originalEvent.target.balloon.open();
         });

         // Структура данных для хранения информации о тепловой камере
         var data = [];
         data.push({ value: "0" });
         data.push({ value: "0" });
         data.push({ value: "0" });
         // Добавление информации в глобальный массив
         objects_data.set(id, data);

         // Добавляем информацию в массив
         heatchambers_array.set(id++, heat_chamber);
         // Добавление на карту
         myMap.geoObjects.add(heat_chamber);
      }

      // Инициализация конечного узла тепловой системы
      function reciever_init(coordinates)
      {
         var reciever = new ymaps.Circle([
            // Центр окружности
            coordinates,
            // Радиус в метрах
            1
         ],
         {
            balloonContent:
               '<button class="show_reciever_info contextButton info" data-reciever_id="' + id + '">Информация</button>' +
               '<br>' +
               '<button class="delete_reciever contextButton" id="deleteReciever" data-reciever_id="' + id + '">Удалить конечный узел</button>'
         },
         {
            // Можно передвигать фигуру
            draggable: true,
            fillColor: '#6632a8',
            strokeColor: '#5032a8',
            strokeWidth: 2,

            zIndex: 200
         });

         // Событие: открыть баллун после окончания перетаскивания (как в giszulu)
         reciever.events.add('dragend', function (e) {
            e.originalEvent.target.balloon.open();
         });

         // Структура данных для хранения информации о конечном узле
         var data = [];
         data.push({ value: "0" });
         data.push({ value: "0" });
         data.push({ value: "0" });
         // Добавление информации в глобальный массив
         objects_data.set(id, data);

         // Добавляем информацию в массив
         recievers_array.set(id++, reciever);
         // Добавление на карту
         myMap.geoObjects.add(reciever);
      }
      
      // Инициализация трубы, на вход подаются координаты точки
      function pipe_init(coordinates)
      {
         var pipe = new ymaps.Polyline([
            coordinates
         ],
         {
            balloonContent:
               '<button class="show_pipe_info contextButton" data-pipe_id="' + id + '">Информация</button>' +
               '<br>' +
               '<button class="delete_pipe contextButton" id="deletePipe" data-pipe_id="' + id + '">Удалить конечный узел</button>'
         },
         {
            zIndex: 100,
            // Толщина линии
            strokeWidth: 4,
            // Добавляем собственные функции
            editorMenuManager: function (items, event) {
               // Удаление всего пути
               items.push({
                  title: "Удалить весь путь",
                  onClick: function () {
                     myMap.geoObjects.remove(pipe);
                     // Удаление из глобальной коллекции
                     pipes_array.delete(pipe.key);
                  }
               });
               items.push({
                  title: "Закончить путь",
                  onClick: function () {
                     pipe.editor.stopEditing();
                  }
               });
               items.push({
                  title: "Ответвление",
                  onClick: function () {
                     branch_init(event.geometry._coordinates);
                     pipe_init(event.geometry._coordinates);
                     //event._parent.editor.stopEditing();
                  }
               });
               items.push({
                  title: "Установить тепловую камеру",
                  onClick: function () {
                     // Меняем центр карты
                     myMap.setCenter(event.geometry._coordinates);
                     // Инициализация тепловой камеры
                     heatchamber_init(event.geometry._coordinates);
                     pipe_init(event.geometry._coordinates);
                     event._parent.editor.stopEditing();
                  }
               });
               items.push({
                  title: "Установить конечный узел",
                  onClick: function () {
                     // Меняем центр карты
                     myMap.setCenter(event.geometry._coordinates);
                     // Инициализация тепловой камеры
                     reciever_init(event.geometry._coordinates);
                     event._parent.editor.stopEditing();
                  }
               });
               return items;
            }
         }
         );

         // Структура данных для хранения информации
         var data = [];
         data.push({ value: "0" });
         // Добавление информации в глобальный массив
         objects_data.set(id, data);

         // Добавляем в глобальный массив объектов
         pipe["key"] = id;
         pipes_array.set(id++, pipe);
         // Добавление на карту
         myMap.geoObjects.add(pipe);
         // Старт режима редактирования линии
         pipe.editor.startDrawing();
      }

      // Функция создания ответвления
      function branch_init(coordinates)
      {
         // Геометрически ответвление представляет собой черный круг
         var branch = new ymaps.Circle([
            // Центр окружности
            coordinates,
            // Радиус в метрах
            1
         ],
         {
            balloonContent:
               '<button class="add_pipe_by_branch contextButton" id="buttonAddPipeByBranch" data-branch_id="' + id + '">Начать путь</button>' +
               '<button class="show_branch_info contextButton info" data-branch_id="' + id + '">Информация</button>' +
               '<br>' +
               '<button class="delete_branch contextButton" id="deleteBranch" data-branch_id="' + id + '">Удалить конечный узел</button>'
         },
         {
            fillColor: '#3d3c3a',
            strokeColor: '#292825',
            strokeWidth: 2,
            zIndex: 200
         });

         // Структура данных для хранения информации об ответвлении
         var data = [];
         data.push({ value: "0" });
         data.push({ value: "0" });
         data.push({ value: "0" });
         // Добавление информации в глобальный массив
         objects_data.set(id, data);

         // Добавляем информацию в массив
         branches_array.set(id++, branch);
         // Добавление на карту
         myMap.geoObjects.add(branch);
      }
   
   </script>
</head>

<body>
   <!--Контейнер для карты-->
   <div id="map" style="width: 60%; height: 600px;"></div>
   <!-- Панель инструменотов -->
   <div id="toolsPanel">
      <table>
         <tr>
            <td><input type="button" value="Построить сеть" id="sourceTool" onclick="source_init()"></td>
         </tr>
         <tr>
            <td><input type="button" value="Найти расход на участках" id="sendValue"></td>
         </tr>
         <tr>
            <td><input type="button" value="Отобразить названия объектов" id="showHideObjectNames" onclick="showHideObjectNames()"></td>
         </tr>
      </table>
   </div>
   <!-- Подключение внешнего файла с функциями обработки геообъектов -->
   <script src="object_handlers.js"></script>
</body>
</html>