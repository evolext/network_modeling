<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Главная страница</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src="./leaflet-providers.js"></script>

    <script src="./Leaflet.Editable.js"></script>
    <script src="./init-objects.js"></script>
    <script src="./server-requests.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="BigImage/Leaflet.BigImage.css">
    <script src="BigImage/Leaflet.BigImage.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="toolsPanel">
        <table id="buttonsOfAdding">
            <caption>Добавить объект</caption>
            <tr>
                <td><input type="button" value="Источник" id="buttonAddSource"/></td>
            </tr>
            <tr>
                <td><input type="button" value="Контррезервуар" id="buttonAddReservoir"></td>
            </tr>
            <tr>
                <td><input type="button" value="Водонапорная башня" id="buttonAddTower"/></td>
            </tr>
            <tr>
                <td><input type="button" value="Колонка" id="buttonAddStandpipe"/></td>
            </tr>
            <tr>
                <td><input type="button" value="Гидрант" id="buttonAddHydrant"/></td>
            </tr>
            <tr>
                <td><input type="button" value="Водопроводный колодец" id="buttonAddWell"/></td>
            </tr>
            <tr>
                <td><input type="button" value="Разветвление" id="buttonAddBranch"/></td>
            </tr>
            <tr>
                <td><input type="button" value="Потребитель" id="buttonAddConsumer"/></td>
            </tr>
        </table>
        <table id="buttonsOfCalculation">
            <caption>Выполнить расчеты</caption>
            <tr>
                <td><input type="button" value="Определить расход"></td>
                <!-- <td><input type="button" value="Определить расход" onclick="sendData()"></td> -->
            </tr>
        </table>
        <table id="buttonsOfControlSchema">
            <caption>Схема</caption>
            <tr>
                <td><input type="button" value="Сохранить" onclick="saveNetwork()"></td>
            </tr>
            <tr>
                <td><input type="button" value="Загрузить" onclick="loadNetwork()"></td>
            </tr>
        </table>
    </div>
</body>
<script>
    var id = 0;
    var geoObjects = [];
    var pipes = new Map();
    var objectsInfo = new Map();
    var pipesInfo = new Map();
    var polylineEditor;

    // Идентификаторр редактируемого пайпа
    var edId = null;
    // Контекстное меню редактируемого пайпа
    var edPopup = null;
    // Контекстное меню пайпа, доступное до редактирования
    var pipePopup = null;

    // Создание объекта карты
    var map = L.map('map', {
        attributionControl: false,
        zoomControl: false,
        center: [54.812074821879456, 82.92755137261244],
        zoom: 14,
        editable: true
    });

    // // Слой для карты
    // L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    //     attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    //     maxZoom: 20,
    //     id: 'evolext/ckdptqjxu0k091isig2sz5xei',
    //     tileSize: 512,
    //     zoomOffset: -1,
    //     accessToken: 'pk.eyJ1IjoiZXZvbGV4dCIsImEiOiJja2Nqeml1dTcxcGJjMnFvOGdsZGxhOHV5In0.eaJ9XIWElB4JaCejC3JpJQ'
    // }).addTo(map);

    // Подложка от яндекса
    L.tileLayer(
        'http://vec{s}.maps.yandex.net/tiles?l=map&v=4.55.2&z={z}&x={x}&y={y}&scale=2&lang=ru_RU', {
            subdomains: ['01', '02', '03', '04'],
            attribution: '<a http="yandex.ru" target="_blank">Яндекс</a>',
            reuseTiles: true,
            updateWhenIdle: false
    }).addTo(map);

    // Своя кастомная подложка
    // L.tileLayer('layer/{z}-{y}x{x}.png',{
    //     minZoom: 2,
    //     maxZoom: 7,
    //     attribution: '',
    //     tms: false
    // }).addTo(map);

    
    // Добавление кнопки экспорта карты
    L.control.bigImage({position: 'topleft'}).addTo(map);

    // Назначение функции добавления объекта на карту по клику
    document.getElementById('toolsPanel').querySelectorAll('#buttonsOfAdding input').forEach((item) => item.addEventListener('click', function(e) {
        // Отключаем обработчики, включенные ранее        
        map.off('click');
        // Определеяем тип добавляемого объекта, извлекаем его с помощью "отсекания" строки buttonAdd от id кнопки
        let obj_type = this.id.slice('buttonAdd'.length).toLowerCase();
        map.on('click', addObjectOnPoint.bind(null, obj_type));
    }));
        
    $('#map').on('click', '.startPipe', function(e) {
        let objId = Number(e.target.dataset.id);
        let index = geoObjects.findIndex((obj) => obj.id == objId);
        initPipe(geoObjects[index].value.getLatLng());
        // Закрытие popup объекта
        geoObjects[index].value.closePopup();
    });

    // Удаление объекта с карты
    $('#map').on('click', '.removeObject', function(e) {
        let objId = Number(e.target.dataset.id);
        let index = geoObjects.findIndex((obj) => obj.id == objId);
        if (index >= 0) {
            geoObjects[index].value.removeFrom(map);
            geoObjects.splice(index, 1);
            objectsInfo.delete(objId);
        }
        else {
            pipes.get(objId).removeFrom(map);
            pipes.delete(objId);
            pipesInfo.delete(objId);
        }
    });

    // Показ информации по объекту
    $('#map').on('click', '.getInfo', function(e) {
        map.closePopup();

        // Запрашиваемая инфомрация по объекту
        let obj_id = Number(e.target.dataset.id);
        let obj_info = objectsInfo.has(obj_id) ? objectsInfo.get(obj_id) : pipesInfo.get(obj_id);

        // Настройка вида открывающегося окна
        let params = 'left=500,top=100,width=330,height=300';
        let new_window = window.open("./info.html", "window", params);

        // Заполнение таблицы с данными
        new_window.addEventListener('load', function() {
            let fields = new_window.document.querySelectorAll('input');
            fields[0].value = obj_info["consumption"].toString();

            // Фокусировка на поле ввода
            fields[0].focus();
        });

        // Обновляем данные после закрытия
        new_window.addEventListener('beforeunload', function() {
            obj_info["consumption"] = Number(new_window.document.querySelectorAll('input')[0].value);
        });

    });

    map.on('popupopen', function(e) {
        // Обрабатываем открытие popup только у объектов
        if (typeof e.popup._source !== 'undefined') {
            // Идентификатор объекта, у которого открывается popup
            let obj_id = geoObjects.find(elem => elem.value._leaflet_id == e.popup._source._leaflet_id).id;
            
            // Устанавилваем переключатель режима в нужное положение
            let checkbox = document.querySelector('input[type="checkbox"]');
            checkbox.checked = (objectsInfo.get(obj_id).activity == 1);
        }
    });

    map.on('editable:vertex:click', function (e) {
        e.vertex.continue();
    });

    map.on('editable:vertex:contextmenu', function (e) {
        map.editTools.stopDrawing();

        // Открытие контекстного меню редактора пайпа
        if (!edPopup) {
            edPopup= L.popup();
            edPopup.setContent(
                "<table>" +
                    "<caption>Путь</caption>" + 
                    "<tr><td><input type='button' value='Продолжить' class='continuePipe popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Завершить редактирование' class='endPipe popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Удалить вершину' class='removeVertex popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Удалить весь путь' class='removePipe popupButton'/></td></tr>" +
                    "<tr>" + 
                        "<td class='switch-container'>" +
                            `Состояние (выкл\\вкл): <label class='switch'><input type='checkbox' class='toggleObject'><span class='slider'></span></label>` + 
                        "</td>" +
                    "</tr>" +
                "</table>" +

                "<table>" +
                    "<caption>Добавить объект</caption>" + 
                    "<tr><td><input type='button' value='Водонапорная башня' class='initTower popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Контррезервуар' class='initReservoir popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Колонка' class='initStandpipe popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Гидрант' class='initHydrant popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Водопроводный колодец' class='initWell popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Разветвление' class='initBranch popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Потребитель' class='initConsumer popupButton'/></td></tr>" +
                "</table>"   
            );
        }
        edPopup.setLatLng(e.latlng);
        edPopup.openOn(map);
        document.querySelectorAll('div.leaflet-popup-content-wrapper table')[1].hidden = false;

        // Индексы кнопок контеекстного меню, которые необходимо отобразить
        let visibleButtons = Array.from(document.querySelectorAll('div.leaflet-popup-content .popupButton')).reduce(function (prev, elem, index) {
            prev.push(index);
            return prev;
        }, []);
        

        if (e.latlng != e.sourceTarget.latlngs[0]) {
            visibleButtons = [1, 3, 8, 9];
            // Для контекстного меню первой вершины пайпа
            document.querySelectorAll('div.leaflet-popup-content-wrapper table')[1].hidden = (e.latlng == e.sourceTarget.latlngs[e.sourceTarget.latlngs.length - 1]) ? true : false;
        }

        // Все пункты контекстного меню
        let buttons = Array.from(document.querySelectorAll('div.leaflet-popup-content .popupButton'));

        for (let i = 0; i < buttons.length; i++) {
            buttons[i].hidden = visibleButtons.includes(i) ? false : true;
        }

        // Устанавливаем правильное положение ползунка в переключателе режима
        let checkbox = document.querySelector('input[type="checkbox"]');
        checkbox.checked = (pipesInfo.get(edId).activity == 1);
    });

    // При соединении двух геообъектов пайпом
    map.on('editable:drawing:click', function(e) {
        let target = e.originalEvent.target;
        if (target.id != 'map') {
            e.cancel();

            // Ставим точку точно в центр геообъекта
            // 1. Находим элемент, по которому прошел клик
            // 2. Получаем точки редактируеемого пайпа и добвляем к ним точку центра объекта, по которому прошел клик
            // 3. Перерисовываем реедактируемый пайп
            let obj = geoObjects.find(elem => elem.value._icon._leaflet_id == target._leaflet_id);
            let pipe = pipes.get(edId);
            let points = pipe.getLatLngs();
            points.unshift(obj.value.getLatLng());
            pipe.redraw();

            // Завершаем редактирование
            pipe.disableEdit();
            pipe.bindPopup(pipePopup);
            polylineEditor = null;
            edId = null;
            pipePopup = null;
        }
    });


    function printMap() {
        domtoimage.toBlob(document.getElementById('map'))
            .then(function (blob) {
                window.saveAs(blob, 'my-node.png');
            });
    }
</script>
<script src="/pipe-popup-events.js"></script>
</html>