<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Главная страница</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <!-- Для кастомных подложек -->
    <script src="./leaflet-providers.js"></script>

    <!-- Модуль для редактирования примитивов-->
    <script src="./Leaflet.Editable.js"></script>

    <!-- Свои модули -->
    <script src="./init-objects.js"></script>
    <script src="./server-requests.js"></script>
    <script src="./panel-buttons.js"></script>


    <!-- модуль BigImage -->
    <link rel="stylesheet" href="BigImage/Leaflet.BigImage.css">
    <script src="BigImage/Leaflet.BigImage.js"></script>
</head>
<body>
    <div id="wrapper">
    <div id="map"></div>
    <div id="toolsPanel">
        <table id="addingNodes" hidden>
            <caption>Добавить объект</caption>
            <tr>
                <td><button id="buttonAddSource"><label>Источник</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddReservoir"><label>Контррезервуар</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddTower"><label>Водонапорная башня</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddStandpipe"><label>Колонка</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddHydrant"><label>Гидрант</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddWell"><label>Водопроводный колодец</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddBranch"><label>Разветвление</label></button></td>
            </tr>
            <tr>
                <td><button id="buttonAddConsumer"><label>Потребитель</label></button></td>
            </tr>
        </table>
        <!-- Панель для выполнения расчетов на сети (пока будет недоступна) -->
        <!-- <table id="buttonsOfCalculation">
            <caption>Выполнение расчетов</caption>
            <tr>
                <td><input type="button" value="Расход на участках"></td>
                <td><input type="button" value="Определить расход" onclick="sendData()"></td>
            </tr>
        </table> -->
        <table id="buttonsOfControlSchema">
            <caption>Схема</caption>
            <tr>
                <td><button id="saveNetwork" hidden>Сохранить</button></td> <!-- onclick="saveNetwork()" -->
            </tr>
            <tr>
                <td><button id="loadNetwork">Загрузить</button></td> <!-- onclick="loadNetwork() -->
            </tr>
            <tr>
                <td><button id="createNetwork" onclick="createNetwork(cancel=false)">Создать новую</button></td>
            </tr>
            <tr>
                <td><button id="createHeatNetwork" onclick="createHeatNetwork()" hidden>Схема теплоснабжения</button></td>
            </tr>
            <tr>
                <td><button id="createWaterNetwork" onclick="createWaterNetwork()" hidden>Схема водоснабжения</button></td>
            </tr>
            <tr>
                <td><button id="cancelCreateNetwork" onclick="createNetwork(cancel=true)" hidden>Отменить</button></td>
            </tr>
        </table>
    </div>
    </div>
</body>
<script>
    var id = 0;
    var geoObjects = [];
    var pipes = new Map();
    var objectsInfo = new Map();
    var pipesInfo = new Map();
    var polylineEditor;
    var area;

    // Идентификаторр редактируемого пайпа
    var edId = null;
    // Контекстное меню редактируемого пайпа
    var edPopup = null;
    // Контекстное меню пайпа, доступное до редактирования
    var pipePopup = null;

    // Создание объекта карты
    var map = L.map('map', {
        attributionControl: false,
        zoomControl: false,
        center: [55.295244847326224, 79.67630911719661],
        zoom: 14,
        editable: true,
        drawControl: true
    });

    // Кастомный классический слой
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 20,
        id: 'evolext/ckdptqjxu0k091isig2sz5xei',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoiZXZvbGV4dCIsImEiOiJja2Nqeml1dTcxcGJjMnFvOGdsZGxhOHV5In0.eaJ9XIWElB4JaCejC3JpJQ'
    }).addTo(map);

    // Более "ландшафтный" слой
    //L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(map);

    // Добавление кнопки экспорта карты
    L.control.bigImage({position: 'topleft'}).addTo(map);

    // Назначение функции добавления объекта на карту по клику
    document.getElementById('toolsPanel').querySelectorAll('#buttonsOfAdding input').forEach((item) => item.addEventListener('click', function(e) {
        // Отключаем обработчики, включенные ранее        
        map.off('click');
        // Определеяем тип добавляемого объекта, извлекаем его с помощью "отсекания" строки buttonAdd от id кнопки
        let obj_type = this.id.slice('buttonAdd'.length).toLowerCase();
        map.on('click', addObjectOnPoint.bind(null, obj_type));
    }));

    
    $('#map').on('click', '.startPipe', function(e) {
        let objId = Number(e.target.dataset.id);
        let index = geoObjects.findIndex((obj) => obj.id == objId);
        initPipe(geoObjects[index].value.getLatLng());
        // Закрытие popup объекта
        geoObjects[index].value.closePopup();
    });

    // Удаление объекта с карты
    $('#map').on('click', '.removeObject', function(e) {
        let objId = Number(e.target.dataset.id);
        let index = geoObjects.findIndex((obj) => obj.id == objId);
        if (index >= 0) {
            geoObjects[index].value.removeFrom(map);
            geoObjects.splice(index, 1);
            objectsInfo.delete(objId);
        }
        else {
            pipes.get(objId).removeFrom(map);
            pipes.delete(objId);
            pipesInfo.delete(objId);
        }
    });

    // Показ информации по объекту
    $('#map').on('click', '.getInfo', function(e) {
        map.closePopup();

        // Запрашиваемая инфомрация по объекту
        let obj_id = Number(e.target.dataset.id);
        let obj_info = objectsInfo.has(obj_id) ? objectsInfo.get(obj_id) : pipesInfo.get(obj_id);

        // Настройка вида открывающегося окна
        let params = 'left=500,top=100,width=330,height=300';
        let new_window = window.open("./info.html", "window", params);

        // Заполнение таблицы с данными
        new_window.addEventListener('load', function() {
            let fields = new_window.document.querySelectorAll('input');
            fields[0].value = obj_info["consumption"].toString();

            // Фокусировка на поле ввода
            fields[0].focus();
        });

        // Обновляем данные после закрытия
        new_window.addEventListener('beforeunload', function() {
            obj_info["consumption"] = Number(new_window.document.querySelectorAll('input')[0].value);
        });

    });

    map.on('popupopen', function(e) {
        if (typeof e.popup._source === 'undefined')
            return;

        // Проверяем, является ли геообъектом (только у них обрабатываем)
        let obj = geoObjects.find(elem => elem.value._leaflet_id == e.popup._source._leaflet_id);
        if (typeof obj !== 'undefined') {
            // Устанавилваем переключатель режима в нужное положение (если объект имеет два режима)
            let checkbox = document.querySelector('input[type="checkbox"]');
            if (checkbox)
                checkbox.checked = (objectsInfo.get(obj.id).activity == 1);
        }
    });

    map.on('editable:vertex:click', function (e) {
        e.vertex.continue();
    });

    map.on('editable:vertex:contextmenu', function (e) {
        map.editTools.stopDrawing();

        // Открытие контекстного меню редактора пайпа
        if (!edPopup) {
            edPopup= L.popup();
            edPopup.setContent(
                "<table>" +
                    "<caption>Путь</caption>" + 
                    "<tr><td><input type='button' value='Продолжить' class='continuePipe popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Завершить редактирование' class='endPipe popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Удалить вершину' class='removeVertex popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Удалить весь путь' class='removePipe popupButton'/></td></tr>" +
                    "<tr>" + 
                        "<td class='switch-container'>" +
                            `Состояние (выкл\\вкл): <label class='switch'><input type='checkbox' class='toggleObject'><span class='slider'></span></label>` + 
                        "</td>" +
                    "</tr>" +
                "</table>" +

                "<table>" +
                    "<caption>Добавить объект</caption>" + 
                    "<tr><td><input type='button' value='Водонапорная башня' class='initTower popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Контррезервуар' class='initReservoir popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Колонка' class='initStandpipe popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Гидрант' class='initHydrant popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Водопроводный колодец' class='initWell popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Разветвление' class='initBranch popupButton'/></td></tr>" +
                    "<tr><td><input type='button' value='Потребитель' class='initConsumer popupButton'/></td></tr>" +
                "</table>"   
            );
        }
        edPopup.setLatLng(e.latlng);
        edPopup.openOn(map);
        document.querySelectorAll('div.leaflet-popup-content-wrapper table')[1].hidden = false;

        // Индексы кнопок контеекстного меню, которые необходимо отобразить
        let visibleButtons = Array.from(document.querySelectorAll('div.leaflet-popup-content .popupButton')).reduce(function (prev, elem, index) {
            prev.push(index);
            return prev;
        }, []);
        

        if (e.latlng != e.sourceTarget.latlngs[0]) {
            visibleButtons = [1, 3, 8, 9];
            // Для контекстного меню первой вершины пайпа
            document.querySelectorAll('div.leaflet-popup-content-wrapper table')[1].hidden = (e.latlng == e.sourceTarget.latlngs[e.sourceTarget.latlngs.length - 1]) ? true : false;
        }

        // Все пункты контекстного меню
        let buttons = Array.from(document.querySelectorAll('div.leaflet-popup-content .popupButton'));

        for (let i = 0; i < buttons.length; i++) {
            buttons[i].hidden = visibleButtons.includes(i) ? false : true;
        }

        // Устанавливаем правильное положение ползунка в переключателе режима
        let checkbox = document.querySelector('input[type="checkbox"]');
        checkbox.checked = (pipesInfo.get(edId).activity == 1);
    });

    // При соединении двух геообъектов пайпом
    map.on('editable:drawing:click', function(e) {
        let target = e.originalEvent.target;
        if (target.id != 'map') {
            e.cancel();

            // Ставим точку точно в центр геообъекта
            // 1. Находим элемент, по которому прошел клик
            // 2. Получаем точки редактируеемого пайпа и добвляем к ним точку центра объекта, по которому прошел клик
            // 3. Перерисовываем реедактируемый пайп
            let obj = geoObjects.find(elem => elem.value._icon._leaflet_id == target._leaflet_id);
            let pipe = pipes.get(edId);
            let points = pipe.getLatLngs();
            points.unshift(obj.value.getLatLng());
            pipe.redraw();

            // Завершаем редактирование
            pipe.disableEdit();
            pipe.bindPopup(pipePopup);
            polylineEditor = null;
            edId = null;
            pipePopup = null;
        }
    });
</script>
<script src="/pipe-popup-events.js"></script>
</html>